<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">
  
  <grid name="wkf-grid" title="Workflows" model="com.axelor.studio.db.Wkf">
      <field name="name"/>
      <field name="metaModel"/>
      <field name="viewBuilder"/>
      <field name="displayTypeSelect" />
  </grid>
    
  <form name="wkf-form" title="Workflow" model="com.axelor.studio.db.Wkf" width="large" 
  	onSave="action-wkf-validate-bpmn-xml,save,action-wfk-method-process-xml,action-wfk-method-process-wkf"
  	onNew="action-wkf-set-default">
     <panel title="Overview">
        <field name="name"/>
        <field name="jsonModel" colSpan="4" showIf="isJson" widget="ref-text" x-target="com.axelor.meta.db.MetaJsonModel" x-target-name="name"/>
        <field name="isJson" onChange="action-wkf-set-model-names" colSpan="2"/>
        <field name="metaModel" hideIf="isJson" widget="ref-text" x-target="com.axelor.meta.db.MetaModel" x-target-name="fullName"/>
        <field name="jsonField" requiredIf="metaModel != null" readonlyIf="metaModel == null" hideIf="isJson" widget="ref-text" x-target="com.axelor.meta.db.MetaField" x-target-name="name" x-domain="self.metaModel.fullName = :metaModel and self.json = true"/>
        <field name="displayTypeSelect" />
        <field name="statusField" onSelect="action-wkf-attrs-set-status-field-domain" onChange="action-wkf-method-set-default-nodes"/>
      	<field name="bpmnXml" showTitle="false" colSpan="12" widget="BpmnEditor" />
      	<field name="$bpmnDefault" hidden="true" type="string" />
      </panel>
  </form>
  
  <action-record name="action-wkf-set-default" model="com.axelor.studio.db.Wkf">
  	<field name="name" expr="eval:_jsonModel + ' workflow'" if="_jsonModel != null"/>
  	<field name="jsonModel" expr="eval:_jsonModel"/>
  </action-record>
  
  <action-method name="action-wfk-method-process-xml">
  	<call class="com.axelor.studio.web.WkfController" method="processXml"/>
  </action-method>
  
  <action-method name="action-wfk-method-process-wkf">
  	<call class="com.axelor.studio.web.WkfController" method="processWkf"/>
  </action-method>
  
  <action-validate name="action-wkf-validate-bpmn-xml">
    <error message="Please correct the workflow diagram." if="bpmnXml == null"/>
  </action-validate>
  
  <action-method name="action-wkf-method-set-default-nodes">
  	<call class="com.axelor.studio.web.WkfController" method="setDefaultNodes"/>
  </action-method>
  
  <action-attrs name="action-wkf-attrs-set-status-field-domain">
  	<attribute name="domain" for="statusField" expr="eval:&quot;self.model = '${metaModel}' and self.modelField = '${jsonField}' and (self.type = 'string' or self.type = 'integer')&quot;" if="!isJson" />
  	<attribute name="domain" for="statusField" expr="eval:&quot;self.jsonModel.name = '${jsonModel}' and (self.type = 'string' or self.type = 'integer')&quot;" if="isJson"/>
  </action-attrs>
  	
</object-views>


