<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">
	
	<grid name="mps-charge-grid" model="com.axelor.apps.production.db.MpsCharge" title="Master Production Scheduling Charge">
		<field name="company"/>
    	<field name="agency"/>
  		<field name="startMonthDate" title="Start Month"/>
  		<field name="endMonthDate" title="End Month"/>  		  	
	</grid>
    
    <form name="mps-charge-form" model="com.axelor.apps.production.db.MpsCharge" title="Master Production Scheduling Charge" width="large" onLoad="action-mps-charge-attrs-show-second-year-chart">
		<toolbar>
    		<button name="printBtn" title="Print" icon="fa-print" onClick="save,action-mps-charge-method-print" showIf="id"/>
  		</toolbar>
    	<panel name="mainPanel">
    		<field name="company"/>
    		<field name="agency"/>
    		<field name="startMonthDate" onChange="action-mps-charge-group-date-on-change"/>
    		<field name="endMonthDate" onChange="action-mps-charge-group-date-on-change"/>
    		<spacer name="buttonSpacer"/>
    		<button name="generateCharge" title="Generate charge lines" onClick="save,dummy-action-fill"/>
    		
    	</panel>
    	<panel-dashlet action="mps-charge-show-mps-charge-lines" name="test" title="Charge lines" colSpan="12"/>
    	<panel name="filterInfoPanel" title="Filters" showIf="company &amp;&amp; startMonthDate &amp;&amp; endMonthDate">
    		<field name="workCenter" onSelect="action-method-mps-charge-work-center-domain" onChange="save,action-mps-charge-group-date-on-change"/>
    	</panel>
    	<panel name="detailsPanel" title="MPS Weekly schedules" showIf="workCenter">
    		<panel-dashlet action="custom:mps-charge-mps-weekley-schedule-custom" name="mpsWeeklySchedualCustomPanel" colSpan="12" showTitle="false"/>
    		<panel-dashlet action="chart:mps.charge.mps.weekley.schedule.chart.first.year" name="mpsWeeklySchedualChartFirstYearPanel" colSpan="12"/>
    	</panel>
    </form>
	
	<action-method name="action-method-mps-charge-work-center-domain">
		<call class="com.axelor.apps.production.web.MpsChargeController" method="computeWorkCenterDomain"/>
	</action-method>
	
	 <custom name="mps-charge-mps-weekley-schedule-custom" title="">
	 	<dataset type="rpc">
	 	<![CDATA[
			com.axelor.apps.production.web.MpsChargeController:getMpsWeeklyScheduleCustom
	 	]]>
	 	</dataset>
	 	<template><![CDATA[
	 		<report-table data='data' columns='code,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52'></report-table>
	 	]]></template>
	 </custom>

	<chart name="mps.charge.mps.weekley.schedule.chart.first.year" title="">
		<dataset type="rpc">
			<![CDATA[
				com.axelor.apps.production.web.MpsChargeController:getMpsWeeklyScheduleChartFirstYear
			]]>
		</dataset>
		<category key="month" type="number"/>
		<series key="count" groupBy="code" type="line"/>
	</chart>

	<chart name="mps.charge.mps.weekley.schedule.chart.second.year" title="">
		<dataset type="rpc">
			<![CDATA[
				com.axelor.apps.production.web.MpsChargeController:getMpsWeeklyScheduleChartSecondYear
			]]>
		</dataset>
		<category key="month" type="month"/>
		<series key="count" groupBy="code" type="line"/>
	</chart>
	<action-method name="dummy-action-fill">
		<call class="com.axelor.apps.production.web.MpsChargeController" method="fillDummy"/>
	</action-method>
	
	<action-group name="action-mps-charge-group-date-on-change">
		<action name="action-mps-charge-validate-date-on-change"/>
		<action name="action-mps-charge-attrs-date-on-change"/>
		<action name="action-mps-charge-attrs-show-second-year-chart"/>
	</action-group>	
	
	<action-attrs name="action-mps-charge-attrs-date-on-change">
		<attribute name="refresh" for="mpsWeeklySchedualCustomPanel,mpsWeeklySchedualChartFirstYearPanel" expr="eval: startMonthDate &amp;&amp; endMonthDate"/>
		<attribute name="refresh" for="mpsWeeklySchedualChartSecondYearPanel" expr="eval: (startMonthDate &amp;&amp; endMonthDate) &amp;&amp; startMonthDate.getYear() != endMonthDate.getYear()"/>
	</action-attrs>

	<action-attrs name="action-mps-charge-attrs-show-second-year-chart">		
		<attribute name="hidden" for="mpsWeeklySchedualChartSecondYearPanel" expr="eval: (startMonthDate &amp;&amp; endMonthDate) &amp;&amp; startMonthDate.getYear() == endMonthDate.getYear()"/>
	</action-attrs>
	
	<action-validate name="action-mps-charge-validate-date-on-change">
		<error message="End month should be after Start Month" if="(startMonthDate &amp;&amp; endMonthDate) &amp;&amp; endMonthDate &lt; startMonthDate"/>
		<error message="Start and End Month should not be more than 12 months apart" if="(startMonthDate &amp;&amp; endMonthDate) &amp;&amp; java.time.Period.between(startMonthDate?.withDayOfMonth(1),endMonthDate?.withDayOfMonth(1)).getYears() &gt;= 1"/>
	</action-validate>
	
	<action-method name="action-mps-charge-method-print">
		<call class="com.axelor.apps.production.web.MpsChargeController" method="print"/>
	</action-method>
	
	<action-view name="mps-charge-show-mps-charge-lines" model="com.axelor.apps.production.db.MpsChargeLine" title="MPS Charge ">
		<view type="grid" name="mps-charge-line-grid"/>
		<view type="form" name="mps-charge-line-form"/>
		<domain>self.mpsCharge = :_mpsChargeId</domain>
		<context name="_mpsChargeId" expr="eval: __this__.id"/>
	</action-view>
	
</object-views>

