<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">

  <grid model="com.axelor.apps.stock.db.DeclarationOfExchanges" title="Declarations of exchanges"
    name="declaration-of-exchanges-grid" orderBy="createdOn" onNew="action-declaration-of-exchanges-onnew">
    <field name="company" onSelect="action-declaration-of-exchanges-company-onselect" canEdit="false"/>
    <field name="country"
      domain="self IN (SELECT sl.address.addressL7Country FROM StockLocation sl WHERE sl.company = :company)"
      canEdit="false"/>
    <field name="fiscalYear" domain="self.company = :company AND self.typeSelect = :YEAR_TYPE_FISCAL"
      onChange="action-declaration-of-exchanges-fiscal-year-onchange" canEdit="false"/>
    <field name="period"
      domain="self.year = :fiscalYear OR :fiscalYear IS NULL AND self.year.company = :company AND self.year.typeSelect = :YEAR_TYPE_FISCAL"
      onChange="action-declaration-of-exchanges-period-onchange" canEdit="false"/>
    <field name="productTypeSelect" onChange="action-declaration-of-exchanges-product-type-select-onchange"/>
    <field name="stockMoveTypeSelect"
      selection-in="[STOCK_MOVE_TYPE_OUTGOING, STOCK_MOVE_TYPE_INCOMING * (productTypeSelect != 'service')]"
      readonlyIf="productTypeSelect == 'service'"/>
    <field name="formatSelect" selection-in="['pdf', 'csv']"/>
    <field name="createdOn"/>
  </grid>

  <form model="com.axelor.apps.stock.db.DeclarationOfExchanges" title="Declaration of exchanges"
    name="declaration-of-exchanges-form" onNew="action-declaration-of-exchanges-onnew" width="large">
    <toolbar>
      <button name="printBtn" title="Print" icon="fa-print" onClick="action-declaration-of-exchanges-export"/>
    </toolbar>

    <panel>
      <field name="company" onSelect="action-declaration-of-exchanges-company-onselect"
        canEdit="false"/>
      <field name="country"
        domain="self IN (SELECT sl.address.addressL7Country FROM StockLocation sl WHERE sl.company = :company)"
        canEdit="false"/>
      <panel name="periodPanel" colSpan="12" showIf="company">
        <field name="fiscalYear" domain="self.company = :company AND self.typeSelect = :YEAR_TYPE_FISCAL"
          onChange="action-declaration-of-exchanges-fiscal-year-onchange" canEdit="false"/>
        <field name="period"
          domain="self.year = :fiscalYear OR :fiscalYear IS NULL AND self.year.company = :company AND self.year.typeSelect = :YEAR_TYPE_FISCAL"
          onChange="action-declaration-of-exchanges-period-onchange" canEdit="false"/>
      </panel>
      <field name="productTypeSelect" onChange="action-declaration-of-exchanges-product-type-select-onchange"/>
      <field name="stockMoveTypeSelect"
        selection-in="[STOCK_MOVE_TYPE_OUTGOING, STOCK_MOVE_TYPE_INCOMING * (productTypeSelect != 'service')]"
        readonlyIf="productTypeSelect == 'service'"/>
      <field name="formatSelect" selection-in="['pdf', 'csv']"/>
      <field name="createdOn" showIf="createdOn"/>
    </panel>
    <panel-dashlet action="action-stock-move-line-declaration-of-exchanges" readonly="true"/>
  </form>

  <action-record name="action-declaration-of-exchanges-onnew" model="com.axelor.apps.stock.db.DeclarationOfExchanges">
    <field name="company" expr="eval: __user__.activeCompany"/>
    <field name="country"
      expr="eval: (__user__.activeCompany?.stockConfig?.pickupDefaultStockLocation?.address ?: __user__.activeCompany?.address)?.addressL7Country"/>
  </action-record>

  <action-record name="action-declaration-of-exchanges-fiscal-year-onchange" model="com.axelor.apps.stock.db.DeclarationOfExchanges">
    <field name="period" expr="eval: null" if="period?.year != fiscalYear"/>
  </action-record>

  <action-record name="action-declaration-of-exchanges-period-onchange" model="com.axelor.apps.stock.db.DeclarationOfExchanges">
    <field name="fiscalYear" expr="eval: period.year" if="!fiscalYear"/>
  </action-record>

  <action-record name="action-declaration-of-exchanges-product-type-select-onchange"
    model="com.axelor.apps.stock.db.DeclarationOfExchanges">
    <field name="stockMoveTypeSelect" expr="eval: STOCK_MOVE_TYPE_OUTGOING" if="productTypeSelect == 'service'"/>
  </action-record>

  <action-attrs name="action-declaration-of-exchanges-company-onselect">
    <attribute name="domain" for="company"
      expr="eval: &quot; self.id IN (${(__user__.companySet?.collect { it.id } ?: [0]).join(', ')}) &quot;"/>
  </action-attrs>

  <action-group name="action-declaration-of-exchanges-export">
    <action name="save"/>
    <action name="action-declaration-of-exchanges-method-export"/>
  </action-group>

  <action-method name="action-declaration-of-exchanges-method-export" model="com.axelor.apps.stock.db.DeclarationOfExchanges">
    <call class="com.axelor.apps.stock.web.DeclarationOfExchangesController" method="export"/>
  </action-method>

</object-views>
